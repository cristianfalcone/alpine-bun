name: Build Alpine Packages

on:
  workflow_dispatch:
    inputs:
      bun_version:
        description: 'Bun version to build (e.g., 1.3.6)'
        required: true
        default: '1.3.6'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-24.04
          - arch: aarch64
            runner: ubuntu-24.04-arm

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h /
          # Remove pre-installed tools we don't need
          # Android SDK: 9.5 GB (x64 only)
          sudo rm -rf /usr/local/lib/android || true
          # Haskell/GHCup: 6.4 GB (x64 only)
          sudo rm -rf /usr/local/.ghcup || true
          # Hosted tool cache: 6 GB (x64 only)
          sudo rm -rf /opt/hostedtoolcache || true
          # .NET SDK: 3.4 GB
          sudo rm -rf /usr/share/dotnet || true
          # Swift: 3.2 GB
          sudo rm -rf /usr/share/swift || true
          # PowerShell: 1.3 GB (arm64 only)
          sudo rm -rf /usr/local/share/powershell || true
          # Clean Docker cache
          sudo docker system prune -af || true
          echo "=== Disk space after cleanup ==="
          df -h /

      - uses: actions/checkout@v4

      - name: Build packages in Alpine container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -e ABUILD_PRIVKEY="${{ secrets.ABUILD_PRIVKEY }}" \
            alpine:edge sh -c '
              set -e

              # Install build dependencies
              apk add --no-cache alpine-sdk

              # Create build user and add to abuild group
              adduser -D builder
              addgroup builder abuild

              # Create and configure distfiles cache
              mkdir -p /var/cache/distfiles
              chgrp abuild /var/cache/distfiles
              chmod g+w /var/cache/distfiles

              # Setup signing keys (both private and public)
              mkdir -p /home/builder/.abuild
              echo "$ABUILD_PRIVKEY" > /home/builder/.abuild/cristianfalcone@gmail.com-799462e3.rsa
              chmod 600 /home/builder/.abuild/cristianfalcone@gmail.com-799462e3.rsa
              cp /workspace/.keys/cristianfalcone@gmail.com-799462e3.rsa.pub /home/builder/.abuild/

              # Configure abuild
              printf "%s\n" \
                "PACKAGER=\"Cristian Falcone <cristianfalcone@gmail.com>\"" \
                "PACKAGER_PRIVKEY=\"/home/builder/.abuild/cristianfalcone@gmail.com-799462e3.rsa\"" \
                > /home/builder/.abuild/abuild.conf

              # Set ownership
              chown -R builder:builder /home/builder

              # Add public key to system trust
              cp /workspace/.keys/cristianfalcone@gmail.com-799462e3.rsa.pub /etc/apk/keys/

              # Give builder ownership of workspace
              chown -R builder:builder /workspace

              # Build bun-bootstrap
              cd /workspace/aports/testing/bun-bootstrap
              su builder -c "abuild -r"

              # Build bun
              cd /workspace/aports/testing/bun
              su builder -c "abuild -r"

              # Collect packages to output directory
              mkdir -p /workspace/output
              cp -r /home/builder/packages/testing/* /workspace/output/
            '

      - name: List built packages
        run: ls -la output/${{ matrix.arch }}/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: output/

  publish:
    needs: build
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Update repository
        run: |
          # Remove old packages
          rm -f edge/testing/x86_64/*.apk edge/testing/x86_64/APKINDEX.tar.gz 2>/dev/null || true
          rm -f edge/testing/aarch64/*.apk edge/testing/aarch64/APKINDEX.tar.gz 2>/dev/null || true

          # Copy new packages
          mkdir -p edge/testing/x86_64 edge/testing/aarch64

          cp artifacts/packages-x86_64/x86_64/*.apk edge/testing/x86_64/
          cp artifacts/packages-x86_64/x86_64/APKINDEX.tar.gz edge/testing/x86_64/

          cp artifacts/packages-aarch64/aarch64/*.apk edge/testing/aarch64/
          cp artifacts/packages-aarch64/aarch64/APKINDEX.tar.gz edge/testing/aarch64/

          # Show results
          echo "=== x86_64 packages ==="
          ls -la edge/testing/x86_64/
          echo "=== aarch64 packages ==="
          ls -la edge/testing/aarch64/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add edge/testing/
          git commit -m "Release bun ${{ github.event.inputs.bun_version }} for x86_64 and aarch64"
          git push
