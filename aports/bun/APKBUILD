# Contributor: Cristian Falcone <cristianfalcone@gmail.com>
# Maintainer: Cristian Falcone <cristianfalcone@gmail.com>
pkgname=bun
pkgver=1.3.6
pkgrel=0
pkgdesc="Incredibly fast JavaScript runtime, bundler, test runner and package manager"
url="https://bun.sh"
arch="x86_64 aarch64"
license="MIT"
depends="libstdc++ libgcc"
makedepends="
	bun-bootstrap
	build-base cmake ninja git curl wget unzip xz
	llvm19 llvm19-dev clang19 clang19-dev lld
	go rust cargo ruby python3 perl
	musl-dev linux-headers libstdc++-dev libc-dev
	gcc g++ bash file binutils
"
subpackages="$pkgname-static"
source="https://github.com/oven-sh/bun/archive/refs/tags/bun-v$pkgver.tar.gz
	static-linking.patch"
options="!check"
provides="bun-bootstrap=$pkgver-r$pkgrel"

prepare() {
	default_prepare
	# Setup LLVM 19 symlinks
	mkdir -p "$builddir"/.llvm/bin
	for tool in clang clang++ llvm-ar llvm-ranlib ld.lld; do
		ln -sf /usr/bin/${tool}-19 "$builddir"/.llvm/bin/$tool 2>/dev/null || \
		ln -sf /usr/bin/$tool "$builddir"/.llvm/bin/$tool
	done
}

build() {
	export AR=/usr/bin/ar
	export RANLIB=/usr/bin/ranlib
	export PATH="/usr/lib/bun-bootstrap:$builddir/.llvm/bin:$PATH"

	bun install --frozen-lockfile || bun install

	# Build dynamic (upstream default)
	bun ./scripts/build.mjs \
		-GNinja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_AR=/usr/bin/ar \
		-DCMAKE_RANLIB=/usr/bin/ranlib \
		-B build/release

	# Build static (with patch)
	cd "$builddir"
	patch -p1 < "$srcdir/static-linking.patch"
	bun ./scripts/build.mjs \
		-GNinja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_AR=/usr/bin/ar \
		-DCMAKE_RANLIB=/usr/bin/ranlib \
		-B build/release-static
}

package() {
	install -Dm755 "$builddir/build/release/bun" "$pkgdir/usr/bin/bun"
	ln -s bun "$pkgdir/usr/bin/bunx"
}

static() {
	pkgdesc="$pkgdesc (statically linked)"
	depends=""

	install -Dm755 "$builddir/build/release-static/bun" \
		"$subpkgdir/usr/bin/bun"
	ln -s bun "$subpkgdir/usr/bin/bunx"
}

sha512sums="
SKIP
SKIP
"
